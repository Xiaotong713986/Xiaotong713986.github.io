"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.printers = exports.parsers = exports.languages = exports.options = void 0;
const prettier_1 = require("prettier");
const doc_1 = require("prettier/doc");
const parser_html_1 = require("prettier/parser-html");
const parse_1 = require("./parse");
const htmlParser = parser_html_1.parsers.html;
const PLUGIN_KEY = "go-template";
exports.options = {
    goTemplateBracketSpacing: {
        type: "boolean",
        category: "Global",
        description: "Specifies whether the brackets should have spacing around the statement.",
        default: true,
    },
};
exports.languages = [
    {
        name: "GoTemplate",
        parsers: [PLUGIN_KEY],
        extensions: [
            ".go.html",
            ".gohtml",
            ".gotmpl",
            ".go.tmpl",
            ".tmpl",
            ".tpl",
            ".html.tmpl",
            ".html.tpl",
        ],
        vscodeLanguageIds: ["gotemplate", "gohtml", "GoTemplate", "GoHTML"],
    },
];
exports.parsers = {
    [PLUGIN_KEY]: {
        astFormat: PLUGIN_KEY,
        preprocess: (text) => text.endsWith("\n") ? text.slice(0, text.length - 1) : text,
        parse: parse_1.parseGoTemplate,
        locStart: (node) => node.index,
        locEnd: (node) => node.index + node.length,
    },
};
exports.printers = {
    [PLUGIN_KEY]: {
        print: (path, options, print) => {
            const node = path.getNode();
            switch (node === null || node === void 0 ? void 0 : node.type) {
                case "inline":
                    return printInline(node, path, options, print);
                case "double-block":
                    return printMultiBlock(node, path, print);
                case "unformattable":
                    return printPlainBlock(node.content, false);
            }
            throw new Error(`An error occured during printing. Found invalid node ${node === null || node === void 0 ? void 0 : node.type}.`);
        },
        embed: (path, print, textToDoc, options) => {
            try {
                return embed(path, print, textToDoc, options);
            }
            catch (e) {
                console.error("Formatting failed.", e);
                throw e;
            }
        },
    },
};
const embed = (path, print, textToDoc, options) => {
    const node = path.getNode();
    if (!node) {
        return null;
    }
    if (hasPrettierIgnoreLine(node)) {
        return options.originalText.substring(options.locStart(node), options.locEnd(node));
    }
    if (node.type !== "block" && node.type !== "root") {
        return null;
    }
    const html = textToDoc(node.aliasedContent, Object.assign(Object.assign({}, options), { parser: "html", parentParser: "go-template" }));
    const mapped = doc_1.utils.stripTrailingHardline(doc_1.utils.mapDoc(html, (currentDoc) => {
        if (typeof currentDoc !== "string") {
            return currentDoc;
        }
        let result = currentDoc;
        Object.keys(node.children).forEach((key) => (result = prettier_1.doc.utils.mapDoc(result, (docNode) => typeof docNode !== "string" || !docNode.includes(key)
            ? docNode
            : doc_1.builders.concat([
                docNode.substring(0, docNode.indexOf(key)),
                path.call(print, "children", key),
                docNode.substring(docNode.indexOf(key) + key.length),
            ]))));
        return result;
    }));
    if ((0, parse_1.isRoot)(node)) {
        return doc_1.builders.concat([mapped, doc_1.builders.hardline]);
    }
    const startStatement = path.call(print, "start");
    const endStatement = node.end ? path.call(print, "end") : "";
    if (isPrettierIgnoreBlock(node)) {
        return doc_1.builders.concat([
            doc_1.utils.removeLines(path.call(print, "start")),
            printPlainBlock(node.content),
            endStatement,
        ]);
    }
    const content = node.aliasedContent.trim()
        ? doc_1.builders.indent(doc_1.builders.concat([doc_1.builders.softline, mapped]))
        : "";
    const result = doc_1.builders.concat([
        startStatement,
        content,
        doc_1.builders.softline,
        endStatement,
    ]);
    const emptyLine = !!node.end && isFollowedByEmptyLine(node.end, options.originalText)
        ? doc_1.builders.softline
        : "";
    if ((0, parse_1.isMultiBlock)(node.parent)) {
        return doc_1.builders.concat([result, emptyLine]);
    }
    return doc_1.builders.group(doc_1.builders.concat([doc_1.builders.group(result), emptyLine]), {
        shouldBreak: !!node.end && hasNodeLinebreak(node.end, options.originalText),
    });
};
function printMultiBlock(node, path, print) {
    return doc_1.builders.concat([...path.map(print, "blocks")]);
}
function isFollowedByNode(node) {
    const parent = getFirstBlockParent(node).parent;
    const start = parent.aliasedContent.indexOf(node.id) + node.id.length;
    let nextNodeIndex = -1;
    Object.keys(parent.children).forEach((key) => {
        const index = parent.aliasedContent.indexOf(key, start);
        if (nextNodeIndex == -1 || index < nextNodeIndex) {
            nextNodeIndex = index;
        }
    });
    return !!parent.aliasedContent
        .substring(start, nextNodeIndex)
        .match(/^\s+$/m);
}
function printInline(node, path, options, print) {
    const isBlockNode = isBlockEnd(node) || isBlockStart(node);
    const emptyLine = isFollowedByEmptyLine(node, options.originalText) && isFollowedByNode(node)
        ? doc_1.builders.softline
        : "";
    const result = [
        printStatement(node.statement, options.goTemplateBracketSpacing, {
            start: node.startDelimiter,
            end: node.endDelimiter,
        }),
    ];
    return doc_1.builders.group(doc_1.builders.concat([...result, emptyLine]), {
        shouldBreak: hasNodeLinebreak(node, options.originalText) && !isBlockNode,
    });
}
function isBlockEnd(node) {
    const { parent } = getFirstBlockParent(node);
    return (0, parse_1.isBlock)(parent) && parent.end === node;
}
function isBlockStart(node) {
    const { parent } = getFirstBlockParent(node);
    return (0, parse_1.isBlock)(parent) && parent.start === node;
}
function printStatement(statement, addSpaces, delimiter = {
    start: "",
    end: "",
}) {
    const space = addSpaces ? " " : "";
    const shouldBreak = statement.includes("\n");
    const content = shouldBreak
        ? statement
            .trim()
            .split("\n")
            .map((line, _, array) => array.indexOf(line) === array.length - 1
            ? doc_1.builders.concat([line.trim(), doc_1.builders.softline])
            : doc_1.builders.indent(doc_1.builders.concat([line.trim(), doc_1.builders.softline])))
        : [statement.trim()];
    return doc_1.builders.group(doc_1.builders.concat([
        "{{",
        delimiter.start,
        space,
        ...content,
        shouldBreak ? "" : space,
        delimiter.end,
        "}}",
    ]), { shouldBreak });
}
function hasPrettierIgnoreLine(node) {
    if ((0, parse_1.isRoot)(node)) {
        return false;
    }
    const { parent, child } = getFirstBlockParent(node);
    const regex = new RegExp(`(?:<!--|{{).*?prettier-ignore.*?(?:-->|}})\n.*${child.id}`);
    return !!parent.aliasedContent.match(regex);
}
function isPrettierIgnoreBlock(node) {
    return (0, parse_1.isBlock)(node) && node.keyword === "prettier-ignore-start";
}
function hasNodeLinebreak(node, source) {
    const start = node.index + node.length;
    const end = source.indexOf("\n", start);
    const suffix = source.substring(start, end);
    return !suffix;
}
function isFollowedByEmptyLine(node, source) {
    const start = node.index + node.length;
    const firstLineBreak = source.indexOf("\n", start);
    const secondLineBreak = source.indexOf("\n", firstLineBreak + 1);
    const emptyLine = source
        .substring(firstLineBreak + 1, secondLineBreak)
        .trim();
    const isLastNode = !!source.substring(start).match(/^\s*$/);
    return (firstLineBreak !== -1 && secondLineBreak !== -1 && !emptyLine && !isLastNode);
}
function getFirstBlockParent(node) {
    let previous = node;
    let current = node.parent;
    while (!(0, parse_1.isBlock)(current) && !(0, parse_1.isRoot)(current)) {
        previous = current;
        current = current.parent;
    }
    return {
        child: previous,
        parent: current,
    };
}
function printPlainBlock(text, hardlines = true) {
    const isTextEmpty = (input) => !!input.match(/^\s*$/);
    const lines = text.split("\n");
    const segments = lines.filter((value, i) => !(i == 0 || i == lines.length - 1) || !isTextEmpty(value));
    return doc_1.builders.concat([
        ...segments.map((content, i) => doc_1.builders.concat([
            hardlines || i ? doc_1.builders.hardline : "",
            doc_1.builders.trim,
            content,
        ])),
        hardlines ? doc_1.builders.hardline : "",
    ]);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsdUNBT2tCO0FBQ2xCLHNDQUErQztBQUMvQyxzREFBOEQ7QUFDOUQsbUNBWWlCO0FBRWpCLE1BQU0sVUFBVSxHQUFHLHFCQUFXLENBQUMsSUFBSSxDQUFDO0FBQ3BDLE1BQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQztBQVNwQixRQUFBLE9BQU8sR0FFaEI7SUFDRix3QkFBd0IsRUFBRTtRQUN4QixJQUFJLEVBQUUsU0FBUztRQUNmLFFBQVEsRUFBRSxRQUFRO1FBQ2xCLFdBQVcsRUFDVCwwRUFBMEU7UUFDNUUsT0FBTyxFQUFFLElBQUk7S0FDZDtDQUNGLENBQUM7QUFFVyxRQUFBLFNBQVMsR0FBc0I7SUFDMUM7UUFDRSxJQUFJLEVBQUUsWUFBWTtRQUNsQixPQUFPLEVBQUUsQ0FBQyxVQUFVLENBQUM7UUFDckIsVUFBVSxFQUFFO1lBQ1YsVUFBVTtZQUNWLFNBQVM7WUFDVCxTQUFTO1lBQ1QsVUFBVTtZQUNWLE9BQU87WUFDUCxNQUFNO1lBQ04sWUFBWTtZQUNaLFdBQVc7U0FDWjtRQUNELGlCQUFpQixFQUFFLENBQUMsWUFBWSxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUUsUUFBUSxDQUFDO0tBQ3BFO0NBQ0YsQ0FBQztBQUNXLFFBQUEsT0FBTyxHQUFHO0lBQ3JCLENBQUMsVUFBVSxDQUFDLEVBQWtCO1FBQzVCLFNBQVMsRUFBRSxVQUFVO1FBQ3JCLFVBQVUsRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFLENBRW5CLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUk7UUFDN0QsS0FBSyxFQUFFLHVCQUFlO1FBQ3RCLFFBQVEsRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUs7UUFDOUIsTUFBTSxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNO0tBQzNDO0NBQ0YsQ0FBQztBQUNXLFFBQUEsUUFBUSxHQUFHO0lBQ3RCLENBQUMsVUFBVSxDQUFDLEVBQW1CO1FBQzdCLEtBQUssRUFBRSxDQUFDLElBQUksRUFBRSxPQUE4QixFQUFFLEtBQUssRUFBRSxFQUFFO1lBQ3JELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUU1QixRQUFRLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxJQUFJLEVBQUU7Z0JBQ2xCLEtBQUssUUFBUTtvQkFDWCxPQUFPLFdBQVcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFDakQsS0FBSyxjQUFjO29CQUNqQixPQUFPLGVBQWUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUM1QyxLQUFLLGVBQWU7b0JBQ2xCLE9BQU8sZUFBZSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7YUFDL0M7WUFFRCxNQUFNLElBQUksS0FBSyxDQUNiLHdEQUF3RCxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsSUFBSSxHQUFHLENBQ3RFLENBQUM7UUFDSixDQUFDO1FBQ0QsS0FBSyxFQUFFLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLEVBQUU7WUFDekMsSUFBSTtnQkFDRixPQUFPLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQzthQUMvQztZQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNWLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZDLE1BQU0sQ0FBQyxDQUFDO2FBQ1Q7UUFDSCxDQUFDO0tBQ0Y7Q0FDRixDQUFDO0FBRUYsTUFBTSxLQUFLLEdBQWlELENBQzFELElBQUksRUFDSixLQUFLLEVBQ0wsU0FBUyxFQUNULE9BQU8sRUFDUCxFQUFFO0lBQ0YsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBRTVCLElBQUksQ0FBQyxJQUFJLEVBQUU7UUFDVCxPQUFPLElBQUksQ0FBQztLQUNiO0lBRUQsSUFBSSxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUMvQixPQUFPLE9BQU8sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUNuQyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUN0QixPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUNyQixDQUFDO0tBQ0g7SUFFRCxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssT0FBTyxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssTUFBTSxFQUFFO1FBQ2pELE9BQU8sSUFBSSxDQUFDO0tBQ2I7SUFFRCxNQUFNLElBQUksR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDLGNBQWMsa0NBQ3JDLE9BQU8sS0FDVixNQUFNLEVBQUUsTUFBTSxFQUNkLFlBQVksRUFBRSxhQUFhLElBQzNCLENBQUM7SUFFSCxNQUFNLE1BQU0sR0FBRyxXQUFLLENBQUMscUJBQXFCLENBQ3hDLFdBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsVUFBVSxFQUFFLEVBQUU7UUFDaEMsSUFBSSxPQUFPLFVBQVUsS0FBSyxRQUFRLEVBQUU7WUFDbEMsT0FBTyxVQUFVLENBQUM7U0FDbkI7UUFFRCxJQUFJLE1BQU0sR0FBaUIsVUFBVSxDQUFDO1FBRXRDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FDaEMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUNOLENBQUMsTUFBTSxHQUFHLGNBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQzdDLE9BQU8sT0FBTyxLQUFLLFFBQVEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDO1lBQ25ELENBQUMsQ0FBQyxPQUFPO1lBQ1QsQ0FBQyxDQUFDLGNBQVEsQ0FBQyxNQUFNLENBQUM7Z0JBQ2QsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDMUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLEdBQUcsQ0FBQztnQkFDakMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUM7YUFDckQsQ0FBQyxDQUNQLENBQUMsQ0FDTCxDQUFDO1FBRUYsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUVGLElBQUksSUFBQSxjQUFNLEVBQUMsSUFBSSxDQUFDLEVBQUU7UUFDaEIsT0FBTyxjQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLGNBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0tBQ3JEO0lBRUQsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDakQsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUU3RCxJQUFJLHFCQUFxQixDQUFDLElBQUksQ0FBQyxFQUFFO1FBQy9CLE9BQU8sY0FBUSxDQUFDLE1BQU0sQ0FBQztZQUNyQixXQUFLLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQzVDLGVBQWUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQzdCLFlBQVk7U0FDYixDQUFDLENBQUM7S0FDSjtJQUVELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFO1FBQ3hDLENBQUMsQ0FBQyxjQUFRLENBQUMsTUFBTSxDQUFDLGNBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxjQUFRLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDL0QsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUVQLE1BQU0sTUFBTSxHQUFHLGNBQVEsQ0FBQyxNQUFNLENBQUM7UUFDN0IsY0FBYztRQUNkLE9BQU87UUFDUCxjQUFRLENBQUMsUUFBUTtRQUNqQixZQUFZO0tBQ2IsQ0FBQyxDQUFDO0lBRUgsTUFBTSxTQUFTLEdBQ2IsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUkscUJBQXFCLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsWUFBWSxDQUFDO1FBQ2pFLENBQUMsQ0FBQyxjQUFRLENBQUMsUUFBUTtRQUNuQixDQUFDLENBQUMsRUFBRSxDQUFDO0lBRVQsSUFBSSxJQUFBLG9CQUFZLEVBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQzdCLE9BQU8sY0FBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO0tBQzdDO0lBRUQsT0FBTyxjQUFRLENBQUMsS0FBSyxDQUFDLGNBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxjQUFRLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDLEVBQUU7UUFDMUUsV0FBVyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLGdCQUFnQixDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLFlBQVksQ0FBQztLQUM1RSxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUM7QUFJRixTQUFTLGVBQWUsQ0FDdEIsSUFBa0IsRUFDbEIsSUFBc0IsRUFDdEIsS0FBYztJQUVkLE9BQU8sY0FBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3pELENBQUM7QUFFRCxTQUFTLGdCQUFnQixDQUFDLElBQWM7SUFDdEMsTUFBTSxNQUFNLEdBQUcsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQ2hELE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQztJQUV0RSxJQUFJLGFBQWEsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUN2QixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtRQUMzQyxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDeEQsSUFBSSxhQUFhLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxHQUFHLGFBQWEsRUFBRTtZQUNoRCxhQUFhLEdBQUcsS0FBSyxDQUFDO1NBQ3ZCO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsY0FBYztTQUMzQixTQUFTLENBQUMsS0FBSyxFQUFFLGFBQWEsQ0FBQztTQUMvQixLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDckIsQ0FBQztBQUVELFNBQVMsV0FBVyxDQUNsQixJQUFjLEVBQ2QsSUFBc0IsRUFDdEIsT0FBOEIsRUFDOUIsS0FBYztJQUVkLE1BQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDM0QsTUFBTSxTQUFTLEdBQ2IscUJBQXFCLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxZQUFZLENBQUMsSUFBSSxnQkFBZ0IsQ0FBQyxJQUFJLENBQUM7UUFDekUsQ0FBQyxDQUFDLGNBQVEsQ0FBQyxRQUFRO1FBQ25CLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFFVCxNQUFNLE1BQU0sR0FBbUI7UUFDN0IsY0FBYyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLHdCQUF3QixFQUFFO1lBQy9ELEtBQUssRUFBRSxJQUFJLENBQUMsY0FBYztZQUMxQixHQUFHLEVBQUUsSUFBSSxDQUFDLFlBQVk7U0FDdkIsQ0FBQztLQUNILENBQUM7SUFFRixPQUFPLGNBQVEsQ0FBQyxLQUFLLENBQUMsY0FBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDLEVBQUU7UUFDN0QsV0FBVyxFQUFFLGdCQUFnQixDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxXQUFXO0tBQzFFLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxTQUFTLFVBQVUsQ0FBQyxJQUFjO0lBQ2hDLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3QyxPQUFPLElBQUEsZUFBTyxFQUFDLE1BQU0sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxHQUFHLEtBQUssSUFBSSxDQUFDO0FBQ2hELENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBQyxJQUFjO0lBQ2xDLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3QyxPQUFPLElBQUEsZUFBTyxFQUFDLE1BQU0sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxLQUFLLEtBQUssSUFBSSxDQUFDO0FBQ2xELENBQUM7QUFFRCxTQUFTLGNBQWMsQ0FDckIsU0FBaUIsRUFDakIsU0FBa0IsRUFDbEIsWUFBMEU7SUFDeEUsS0FBSyxFQUFFLEVBQUU7SUFDVCxHQUFHLEVBQUUsRUFBRTtDQUNSO0lBRUQsTUFBTSxLQUFLLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUNuQyxNQUFNLFdBQVcsR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRTdDLE1BQU0sT0FBTyxHQUFHLFdBQVc7UUFDekIsQ0FBQyxDQUFDLFNBQVM7YUFDTixJQUFJLEVBQUU7YUFDTixLQUFLLENBQUMsSUFBSSxDQUFDO2FBQ1gsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUN0QixLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQztZQUN0QyxDQUFDLENBQUMsY0FBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsRUFBRSxjQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDbkQsQ0FBQyxDQUFDLGNBQVEsQ0FBQyxNQUFNLENBQUMsY0FBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsRUFBRSxjQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUN2RTtRQUNMLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBRXZCLE9BQU8sY0FBUSxDQUFDLEtBQUssQ0FDbkIsY0FBUSxDQUFDLE1BQU0sQ0FBQztRQUNkLElBQUk7UUFDSixTQUFTLENBQUMsS0FBSztRQUNmLEtBQUs7UUFDTCxHQUFHLE9BQU87UUFDVixXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSztRQUN4QixTQUFTLENBQUMsR0FBRztRQUNiLElBQUk7S0FDTCxDQUFDLEVBQ0YsRUFBRSxXQUFXLEVBQUUsQ0FDaEIsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLHFCQUFxQixDQUFDLElBQVk7SUFDekMsSUFBSSxJQUFBLGNBQU0sRUFBQyxJQUFJLENBQUMsRUFBRTtRQUNoQixPQUFPLEtBQUssQ0FBQztLQUNkO0lBRUQsTUFBTSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVwRCxNQUFNLEtBQUssR0FBRyxJQUFJLE1BQU0sQ0FDdEIsaURBQWlELEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FDNUQsQ0FBQztJQUVGLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzlDLENBQUM7QUFFRCxTQUFTLHFCQUFxQixDQUFDLElBQVk7SUFDekMsT0FBTyxJQUFBLGVBQU8sRUFBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsT0FBTyxLQUFLLHVCQUF1QixDQUFDO0FBQ25FLENBQUM7QUFFRCxTQUFTLGdCQUFnQixDQUFDLElBQWMsRUFBRSxNQUFjO0lBQ3RELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN2QyxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztJQUN4QyxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztJQUU1QyxPQUFPLENBQUMsTUFBTSxDQUFDO0FBQ2pCLENBQUM7QUFFRCxTQUFTLHFCQUFxQixDQUFDLElBQWMsRUFBRSxNQUFjO0lBQzNELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN2QyxNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNuRCxNQUFNLGVBQWUsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxjQUFjLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDakUsTUFBTSxTQUFTLEdBQUcsTUFBTTtTQUNyQixTQUFTLENBQUMsY0FBYyxHQUFHLENBQUMsRUFBRSxlQUFlLENBQUM7U0FDOUMsSUFBSSxFQUFFLENBQUM7SUFDVixNQUFNLFVBQVUsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFNUQsT0FBTyxDQUNMLGNBQWMsS0FBSyxDQUFDLENBQUMsSUFBSSxlQUFlLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLElBQUksQ0FBQyxVQUFVLENBQzdFLENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyxtQkFBbUIsQ0FBQyxJQUE2QjtJQUl4RCxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUM7SUFDcEIsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUUxQixPQUFPLENBQUMsSUFBQSxlQUFPLEVBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFBLGNBQU0sRUFBQyxPQUFPLENBQUMsRUFBRTtRQUM1QyxRQUFRLEdBQUcsT0FBTyxDQUFDO1FBQ25CLE9BQU8sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO0tBQzFCO0lBRUQsT0FBTztRQUNMLEtBQUssRUFBRSxRQUFRO1FBQ2YsTUFBTSxFQUFFLE9BQU87S0FDaEIsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLGVBQWUsQ0FBQyxJQUFZLEVBQUUsU0FBUyxHQUFHLElBQUk7SUFDckQsTUFBTSxXQUFXLEdBQUcsQ0FBQyxLQUFhLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRTlELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFL0IsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FDM0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FDeEUsQ0FBQztJQUVGLE9BQU8sY0FBUSxDQUFDLE1BQU0sQ0FBQztRQUNyQixHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FDN0IsY0FBUSxDQUFDLE1BQU0sQ0FBQztZQUNkLFNBQVMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLGNBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDdkMsY0FBUSxDQUFDLElBQUk7WUFDYixPQUFPO1NBQ1IsQ0FBQyxDQUNIO1FBQ0QsU0FBUyxDQUFDLENBQUMsQ0FBQyxjQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFO0tBQ25DLENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBkb2MsXG4gIEZhc3RQYXRoLFxuICBQYXJzZXIsXG4gIFBhcnNlck9wdGlvbnMsXG4gIFByaW50ZXIsXG4gIFN1cHBvcnRMYW5ndWFnZSxcbn0gZnJvbSBcInByZXR0aWVyXCI7XG5pbXBvcnQgeyBidWlsZGVycywgdXRpbHMgfSBmcm9tIFwicHJldHRpZXIvZG9jXCI7XG5pbXBvcnQgeyBwYXJzZXJzIGFzIGh0bWxQYXJzZXJzIH0gZnJvbSBcInByZXR0aWVyL3BhcnNlci1odG1sXCI7XG5pbXBvcnQge1xuICBHb0Jsb2NrLFxuICBHb0lubGluZSxcbiAgR29JbmxpbmVFbmREZWxpbWl0ZXIsXG4gIEdvSW5saW5lU3RhcnREZWxpbWl0ZXIsXG4gIEdvTXVsdGlCbG9jayxcbiAgR29Ob2RlLFxuICBHb1Jvb3QsXG4gIGlzQmxvY2ssXG4gIGlzTXVsdGlCbG9jayxcbiAgaXNSb290LFxuICBwYXJzZUdvVGVtcGxhdGUsXG59IGZyb20gXCIuL3BhcnNlXCI7XG5cbmNvbnN0IGh0bWxQYXJzZXIgPSBodG1sUGFyc2Vycy5odG1sO1xuY29uc3QgUExVR0lOX0tFWSA9IFwiZ28tdGVtcGxhdGVcIjtcblxudHlwZSBFeHRlbmRlZFBhcnNlck9wdGlvbnMgPSBQYXJzZXJPcHRpb25zPEdvTm9kZT4gJlxuICBQcmV0dGllclBsdWdpbkdvVGVtcGxhdGVQYXJzZXJPcHRpb25zO1xuXG5leHBvcnQgdHlwZSBQcmV0dGllclBsdWdpbkdvVGVtcGxhdGVQYXJzZXJPcHRpb25zID0ge1xuICBnb1RlbXBsYXRlQnJhY2tldFNwYWNpbmc6IGJvb2xlYW47XG59O1xuXG5leHBvcnQgY29uc3Qgb3B0aW9uczoge1xuICBbSyBpbiBrZXlvZiBQcmV0dGllclBsdWdpbkdvVGVtcGxhdGVQYXJzZXJPcHRpb25zXTogYW55O1xufSA9IHtcbiAgZ29UZW1wbGF0ZUJyYWNrZXRTcGFjaW5nOiB7XG4gICAgdHlwZTogXCJib29sZWFuXCIsXG4gICAgY2F0ZWdvcnk6IFwiR2xvYmFsXCIsXG4gICAgZGVzY3JpcHRpb246XG4gICAgICBcIlNwZWNpZmllcyB3aGV0aGVyIHRoZSBicmFja2V0cyBzaG91bGQgaGF2ZSBzcGFjaW5nIGFyb3VuZCB0aGUgc3RhdGVtZW50LlwiLFxuICAgIGRlZmF1bHQ6IHRydWUsXG4gIH0sXG59O1xuXG5leHBvcnQgY29uc3QgbGFuZ3VhZ2VzOiBTdXBwb3J0TGFuZ3VhZ2VbXSA9IFtcbiAge1xuICAgIG5hbWU6IFwiR29UZW1wbGF0ZVwiLFxuICAgIHBhcnNlcnM6IFtQTFVHSU5fS0VZXSxcbiAgICBleHRlbnNpb25zOiBbXG4gICAgICBcIi5nby5odG1sXCIsXG4gICAgICBcIi5nb2h0bWxcIixcbiAgICAgIFwiLmdvdG1wbFwiLFxuICAgICAgXCIuZ28udG1wbFwiLFxuICAgICAgXCIudG1wbFwiLFxuICAgICAgXCIudHBsXCIsXG4gICAgICBcIi5odG1sLnRtcGxcIixcbiAgICAgIFwiLmh0bWwudHBsXCIsXG4gICAgXSxcbiAgICB2c2NvZGVMYW5ndWFnZUlkczogW1wiZ290ZW1wbGF0ZVwiLCBcImdvaHRtbFwiLCBcIkdvVGVtcGxhdGVcIiwgXCJHb0hUTUxcIl0sXG4gIH0sXG5dO1xuZXhwb3J0IGNvbnN0IHBhcnNlcnMgPSB7XG4gIFtQTFVHSU5fS0VZXTogPFBhcnNlcjxHb05vZGU+PntcbiAgICBhc3RGb3JtYXQ6IFBMVUdJTl9LRVksXG4gICAgcHJlcHJvY2VzczogKHRleHQpID0+XG4gICAgICAvLyBDdXQgYXdheSB0cmFpbGluZyBuZXdsaW5lIHRvIG5vcm1hbGl6ZSBmb3JtYXR0aW5nLlxuICAgICAgdGV4dC5lbmRzV2l0aChcIlxcblwiKSA/IHRleHQuc2xpY2UoMCwgdGV4dC5sZW5ndGggLSAxKSA6IHRleHQsXG4gICAgcGFyc2U6IHBhcnNlR29UZW1wbGF0ZSxcbiAgICBsb2NTdGFydDogKG5vZGUpID0+IG5vZGUuaW5kZXgsXG4gICAgbG9jRW5kOiAobm9kZSkgPT4gbm9kZS5pbmRleCArIG5vZGUubGVuZ3RoLFxuICB9LFxufTtcbmV4cG9ydCBjb25zdCBwcmludGVycyA9IHtcbiAgW1BMVUdJTl9LRVldOiA8UHJpbnRlcjxHb05vZGU+PntcbiAgICBwcmludDogKHBhdGgsIG9wdGlvbnM6IEV4dGVuZGVkUGFyc2VyT3B0aW9ucywgcHJpbnQpID0+IHtcbiAgICAgIGNvbnN0IG5vZGUgPSBwYXRoLmdldE5vZGUoKTtcblxuICAgICAgc3dpdGNoIChub2RlPy50eXBlKSB7XG4gICAgICAgIGNhc2UgXCJpbmxpbmVcIjpcbiAgICAgICAgICByZXR1cm4gcHJpbnRJbmxpbmUobm9kZSwgcGF0aCwgb3B0aW9ucywgcHJpbnQpO1xuICAgICAgICBjYXNlIFwiZG91YmxlLWJsb2NrXCI6XG4gICAgICAgICAgcmV0dXJuIHByaW50TXVsdGlCbG9jayhub2RlLCBwYXRoLCBwcmludCk7XG4gICAgICAgIGNhc2UgXCJ1bmZvcm1hdHRhYmxlXCI6XG4gICAgICAgICAgcmV0dXJuIHByaW50UGxhaW5CbG9jayhub2RlLmNvbnRlbnQsIGZhbHNlKTtcbiAgICAgIH1cblxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQW4gZXJyb3Igb2NjdXJlZCBkdXJpbmcgcHJpbnRpbmcuIEZvdW5kIGludmFsaWQgbm9kZSAke25vZGU/LnR5cGV9LmBcbiAgICAgICk7XG4gICAgfSxcbiAgICBlbWJlZDogKHBhdGgsIHByaW50LCB0ZXh0VG9Eb2MsIG9wdGlvbnMpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBlbWJlZChwYXRoLCBwcmludCwgdGV4dFRvRG9jLCBvcHRpb25zKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIkZvcm1hdHRpbmcgZmFpbGVkLlwiLCBlKTtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICB9LFxuICB9LFxufTtcblxuY29uc3QgZW1iZWQ6IEV4Y2x1ZGU8UHJpbnRlcjxHb05vZGU+W1wiZW1iZWRcIl0sIHVuZGVmaW5lZD4gPSAoXG4gIHBhdGgsXG4gIHByaW50LFxuICB0ZXh0VG9Eb2MsXG4gIG9wdGlvbnNcbikgPT4ge1xuICBjb25zdCBub2RlID0gcGF0aC5nZXROb2RlKCk7XG5cbiAgaWYgKCFub2RlKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBpZiAoaGFzUHJldHRpZXJJZ25vcmVMaW5lKG5vZGUpKSB7XG4gICAgcmV0dXJuIG9wdGlvbnMub3JpZ2luYWxUZXh0LnN1YnN0cmluZyhcbiAgICAgIG9wdGlvbnMubG9jU3RhcnQobm9kZSksXG4gICAgICBvcHRpb25zLmxvY0VuZChub2RlKVxuICAgICk7XG4gIH1cblxuICBpZiAobm9kZS50eXBlICE9PSBcImJsb2NrXCIgJiYgbm9kZS50eXBlICE9PSBcInJvb3RcIikge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgY29uc3QgaHRtbCA9IHRleHRUb0RvYyhub2RlLmFsaWFzZWRDb250ZW50LCB7XG4gICAgLi4ub3B0aW9ucyxcbiAgICBwYXJzZXI6IFwiaHRtbFwiLFxuICAgIHBhcmVudFBhcnNlcjogXCJnby10ZW1wbGF0ZVwiLFxuICB9KTtcblxuICBjb25zdCBtYXBwZWQgPSB1dGlscy5zdHJpcFRyYWlsaW5nSGFyZGxpbmUoXG4gICAgdXRpbHMubWFwRG9jKGh0bWwsIChjdXJyZW50RG9jKSA9PiB7XG4gICAgICBpZiAodHlwZW9mIGN1cnJlbnREb2MgIT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgcmV0dXJuIGN1cnJlbnREb2M7XG4gICAgICB9XG5cbiAgICAgIGxldCByZXN1bHQ6IGJ1aWxkZXJzLkRvYyA9IGN1cnJlbnREb2M7XG5cbiAgICAgIE9iamVjdC5rZXlzKG5vZGUuY2hpbGRyZW4pLmZvckVhY2goXG4gICAgICAgIChrZXkpID0+XG4gICAgICAgICAgKHJlc3VsdCA9IGRvYy51dGlscy5tYXBEb2MocmVzdWx0LCAoZG9jTm9kZSkgPT5cbiAgICAgICAgICAgIHR5cGVvZiBkb2NOb2RlICE9PSBcInN0cmluZ1wiIHx8ICFkb2NOb2RlLmluY2x1ZGVzKGtleSlcbiAgICAgICAgICAgICAgPyBkb2NOb2RlXG4gICAgICAgICAgICAgIDogYnVpbGRlcnMuY29uY2F0KFtcbiAgICAgICAgICAgICAgICAgIGRvY05vZGUuc3Vic3RyaW5nKDAsIGRvY05vZGUuaW5kZXhPZihrZXkpKSxcbiAgICAgICAgICAgICAgICAgIHBhdGguY2FsbChwcmludCwgXCJjaGlsZHJlblwiLCBrZXkpLFxuICAgICAgICAgICAgICAgICAgZG9jTm9kZS5zdWJzdHJpbmcoZG9jTm9kZS5pbmRleE9mKGtleSkgKyBrZXkubGVuZ3RoKSxcbiAgICAgICAgICAgICAgICBdKVxuICAgICAgICAgICkpXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0pXG4gICk7XG5cbiAgaWYgKGlzUm9vdChub2RlKSkge1xuICAgIHJldHVybiBidWlsZGVycy5jb25jYXQoW21hcHBlZCwgYnVpbGRlcnMuaGFyZGxpbmVdKTtcbiAgfVxuXG4gIGNvbnN0IHN0YXJ0U3RhdGVtZW50ID0gcGF0aC5jYWxsKHByaW50LCBcInN0YXJ0XCIpO1xuICBjb25zdCBlbmRTdGF0ZW1lbnQgPSBub2RlLmVuZCA/IHBhdGguY2FsbChwcmludCwgXCJlbmRcIikgOiBcIlwiO1xuXG4gIGlmIChpc1ByZXR0aWVySWdub3JlQmxvY2sobm9kZSkpIHtcbiAgICByZXR1cm4gYnVpbGRlcnMuY29uY2F0KFtcbiAgICAgIHV0aWxzLnJlbW92ZUxpbmVzKHBhdGguY2FsbChwcmludCwgXCJzdGFydFwiKSksXG4gICAgICBwcmludFBsYWluQmxvY2sobm9kZS5jb250ZW50KSxcbiAgICAgIGVuZFN0YXRlbWVudCxcbiAgICBdKTtcbiAgfVxuXG4gIGNvbnN0IGNvbnRlbnQgPSBub2RlLmFsaWFzZWRDb250ZW50LnRyaW0oKVxuICAgID8gYnVpbGRlcnMuaW5kZW50KGJ1aWxkZXJzLmNvbmNhdChbYnVpbGRlcnMuc29mdGxpbmUsIG1hcHBlZF0pKVxuICAgIDogXCJcIjtcblxuICBjb25zdCByZXN1bHQgPSBidWlsZGVycy5jb25jYXQoW1xuICAgIHN0YXJ0U3RhdGVtZW50LFxuICAgIGNvbnRlbnQsXG4gICAgYnVpbGRlcnMuc29mdGxpbmUsXG4gICAgZW5kU3RhdGVtZW50LFxuICBdKTtcblxuICBjb25zdCBlbXB0eUxpbmUgPVxuICAgICEhbm9kZS5lbmQgJiYgaXNGb2xsb3dlZEJ5RW1wdHlMaW5lKG5vZGUuZW5kLCBvcHRpb25zLm9yaWdpbmFsVGV4dClcbiAgICAgID8gYnVpbGRlcnMuc29mdGxpbmVcbiAgICAgIDogXCJcIjtcblxuICBpZiAoaXNNdWx0aUJsb2NrKG5vZGUucGFyZW50KSkge1xuICAgIHJldHVybiBidWlsZGVycy5jb25jYXQoW3Jlc3VsdCwgZW1wdHlMaW5lXSk7XG4gIH1cblxuICByZXR1cm4gYnVpbGRlcnMuZ3JvdXAoYnVpbGRlcnMuY29uY2F0KFtidWlsZGVycy5ncm91cChyZXN1bHQpLCBlbXB0eUxpbmVdKSwge1xuICAgIHNob3VsZEJyZWFrOiAhIW5vZGUuZW5kICYmIGhhc05vZGVMaW5lYnJlYWsobm9kZS5lbmQsIG9wdGlvbnMub3JpZ2luYWxUZXh0KSxcbiAgfSk7XG59O1xuXG50eXBlIFByaW50Rm4gPSAocGF0aDogRmFzdFBhdGg8R29Ob2RlPikgPT4gYnVpbGRlcnMuRG9jO1xuXG5mdW5jdGlvbiBwcmludE11bHRpQmxvY2soXG4gIG5vZGU6IEdvTXVsdGlCbG9jayxcbiAgcGF0aDogRmFzdFBhdGg8R29Ob2RlPixcbiAgcHJpbnQ6IFByaW50Rm5cbik6IGJ1aWxkZXJzLkRvYyB7XG4gIHJldHVybiBidWlsZGVycy5jb25jYXQoWy4uLnBhdGgubWFwKHByaW50LCBcImJsb2Nrc1wiKV0pO1xufVxuXG5mdW5jdGlvbiBpc0ZvbGxvd2VkQnlOb2RlKG5vZGU6IEdvSW5saW5lKTogYm9vbGVhbiB7XG4gIGNvbnN0IHBhcmVudCA9IGdldEZpcnN0QmxvY2tQYXJlbnQobm9kZSkucGFyZW50O1xuICBjb25zdCBzdGFydCA9IHBhcmVudC5hbGlhc2VkQ29udGVudC5pbmRleE9mKG5vZGUuaWQpICsgbm9kZS5pZC5sZW5ndGg7XG5cbiAgbGV0IG5leHROb2RlSW5kZXggPSAtMTtcbiAgT2JqZWN0LmtleXMocGFyZW50LmNoaWxkcmVuKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICBjb25zdCBpbmRleCA9IHBhcmVudC5hbGlhc2VkQ29udGVudC5pbmRleE9mKGtleSwgc3RhcnQpO1xuICAgIGlmIChuZXh0Tm9kZUluZGV4ID09IC0xIHx8IGluZGV4IDwgbmV4dE5vZGVJbmRleCkge1xuICAgICAgbmV4dE5vZGVJbmRleCA9IGluZGV4O1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuICEhcGFyZW50LmFsaWFzZWRDb250ZW50XG4gICAgLnN1YnN0cmluZyhzdGFydCwgbmV4dE5vZGVJbmRleClcbiAgICAubWF0Y2goL15cXHMrJC9tKTtcbn1cblxuZnVuY3Rpb24gcHJpbnRJbmxpbmUoXG4gIG5vZGU6IEdvSW5saW5lLFxuICBwYXRoOiBGYXN0UGF0aDxHb05vZGU+LFxuICBvcHRpb25zOiBFeHRlbmRlZFBhcnNlck9wdGlvbnMsXG4gIHByaW50OiBQcmludEZuXG4pOiBidWlsZGVycy5Eb2Mge1xuICBjb25zdCBpc0Jsb2NrTm9kZSA9IGlzQmxvY2tFbmQobm9kZSkgfHwgaXNCbG9ja1N0YXJ0KG5vZGUpO1xuICBjb25zdCBlbXB0eUxpbmUgPVxuICAgIGlzRm9sbG93ZWRCeUVtcHR5TGluZShub2RlLCBvcHRpb25zLm9yaWdpbmFsVGV4dCkgJiYgaXNGb2xsb3dlZEJ5Tm9kZShub2RlKVxuICAgICAgPyBidWlsZGVycy5zb2Z0bGluZVxuICAgICAgOiBcIlwiO1xuXG4gIGNvbnN0IHJlc3VsdDogYnVpbGRlcnMuRG9jW10gPSBbXG4gICAgcHJpbnRTdGF0ZW1lbnQobm9kZS5zdGF0ZW1lbnQsIG9wdGlvbnMuZ29UZW1wbGF0ZUJyYWNrZXRTcGFjaW5nLCB7XG4gICAgICBzdGFydDogbm9kZS5zdGFydERlbGltaXRlcixcbiAgICAgIGVuZDogbm9kZS5lbmREZWxpbWl0ZXIsXG4gICAgfSksXG4gIF07XG5cbiAgcmV0dXJuIGJ1aWxkZXJzLmdyb3VwKGJ1aWxkZXJzLmNvbmNhdChbLi4ucmVzdWx0LCBlbXB0eUxpbmVdKSwge1xuICAgIHNob3VsZEJyZWFrOiBoYXNOb2RlTGluZWJyZWFrKG5vZGUsIG9wdGlvbnMub3JpZ2luYWxUZXh0KSAmJiAhaXNCbG9ja05vZGUsXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBpc0Jsb2NrRW5kKG5vZGU6IEdvSW5saW5lKSB7XG4gIGNvbnN0IHsgcGFyZW50IH0gPSBnZXRGaXJzdEJsb2NrUGFyZW50KG5vZGUpO1xuICByZXR1cm4gaXNCbG9jayhwYXJlbnQpICYmIHBhcmVudC5lbmQgPT09IG5vZGU7XG59XG5cbmZ1bmN0aW9uIGlzQmxvY2tTdGFydChub2RlOiBHb0lubGluZSkge1xuICBjb25zdCB7IHBhcmVudCB9ID0gZ2V0Rmlyc3RCbG9ja1BhcmVudChub2RlKTtcbiAgcmV0dXJuIGlzQmxvY2socGFyZW50KSAmJiBwYXJlbnQuc3RhcnQgPT09IG5vZGU7XG59XG5cbmZ1bmN0aW9uIHByaW50U3RhdGVtZW50KFxuICBzdGF0ZW1lbnQ6IHN0cmluZyxcbiAgYWRkU3BhY2VzOiBib29sZWFuLFxuICBkZWxpbWl0ZXI6IHsgc3RhcnQ6IEdvSW5saW5lU3RhcnREZWxpbWl0ZXI7IGVuZDogR29JbmxpbmVFbmREZWxpbWl0ZXIgfSA9IHtcbiAgICBzdGFydDogXCJcIixcbiAgICBlbmQ6IFwiXCIsXG4gIH1cbikge1xuICBjb25zdCBzcGFjZSA9IGFkZFNwYWNlcyA/IFwiIFwiIDogXCJcIjtcbiAgY29uc3Qgc2hvdWxkQnJlYWsgPSBzdGF0ZW1lbnQuaW5jbHVkZXMoXCJcXG5cIik7XG5cbiAgY29uc3QgY29udGVudCA9IHNob3VsZEJyZWFrXG4gICAgPyBzdGF0ZW1lbnRcbiAgICAgICAgLnRyaW0oKVxuICAgICAgICAuc3BsaXQoXCJcXG5cIilcbiAgICAgICAgLm1hcCgobGluZSwgXywgYXJyYXkpID0+XG4gICAgICAgICAgYXJyYXkuaW5kZXhPZihsaW5lKSA9PT0gYXJyYXkubGVuZ3RoIC0gMVxuICAgICAgICAgICAgPyBidWlsZGVycy5jb25jYXQoW2xpbmUudHJpbSgpLCBidWlsZGVycy5zb2Z0bGluZV0pXG4gICAgICAgICAgICA6IGJ1aWxkZXJzLmluZGVudChidWlsZGVycy5jb25jYXQoW2xpbmUudHJpbSgpLCBidWlsZGVycy5zb2Z0bGluZV0pKVxuICAgICAgICApXG4gICAgOiBbc3RhdGVtZW50LnRyaW0oKV07XG5cbiAgcmV0dXJuIGJ1aWxkZXJzLmdyb3VwKFxuICAgIGJ1aWxkZXJzLmNvbmNhdChbXG4gICAgICBcInt7XCIsXG4gICAgICBkZWxpbWl0ZXIuc3RhcnQsXG4gICAgICBzcGFjZSxcbiAgICAgIC4uLmNvbnRlbnQsXG4gICAgICBzaG91bGRCcmVhayA/IFwiXCIgOiBzcGFjZSxcbiAgICAgIGRlbGltaXRlci5lbmQsXG4gICAgICBcIn19XCIsXG4gICAgXSksXG4gICAgeyBzaG91bGRCcmVhayB9XG4gICk7XG59XG5cbmZ1bmN0aW9uIGhhc1ByZXR0aWVySWdub3JlTGluZShub2RlOiBHb05vZGUpIHtcbiAgaWYgKGlzUm9vdChub2RlKSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGNvbnN0IHsgcGFyZW50LCBjaGlsZCB9ID0gZ2V0Rmlyc3RCbG9ja1BhcmVudChub2RlKTtcblxuICBjb25zdCByZWdleCA9IG5ldyBSZWdFeHAoXG4gICAgYCg/OjwhLS18e3spLio/cHJldHRpZXItaWdub3JlLio/KD86LS0+fH19KVxcbi4qJHtjaGlsZC5pZH1gXG4gICk7XG5cbiAgcmV0dXJuICEhcGFyZW50LmFsaWFzZWRDb250ZW50Lm1hdGNoKHJlZ2V4KTtcbn1cblxuZnVuY3Rpb24gaXNQcmV0dGllcklnbm9yZUJsb2NrKG5vZGU6IEdvTm9kZSkge1xuICByZXR1cm4gaXNCbG9jayhub2RlKSAmJiBub2RlLmtleXdvcmQgPT09IFwicHJldHRpZXItaWdub3JlLXN0YXJ0XCI7XG59XG5cbmZ1bmN0aW9uIGhhc05vZGVMaW5lYnJlYWsobm9kZTogR29JbmxpbmUsIHNvdXJjZTogc3RyaW5nKSB7XG4gIGNvbnN0IHN0YXJ0ID0gbm9kZS5pbmRleCArIG5vZGUubGVuZ3RoO1xuICBjb25zdCBlbmQgPSBzb3VyY2UuaW5kZXhPZihcIlxcblwiLCBzdGFydCk7XG4gIGNvbnN0IHN1ZmZpeCA9IHNvdXJjZS5zdWJzdHJpbmcoc3RhcnQsIGVuZCk7XG5cbiAgcmV0dXJuICFzdWZmaXg7XG59XG5cbmZ1bmN0aW9uIGlzRm9sbG93ZWRCeUVtcHR5TGluZShub2RlOiBHb0lubGluZSwgc291cmNlOiBzdHJpbmcpIHtcbiAgY29uc3Qgc3RhcnQgPSBub2RlLmluZGV4ICsgbm9kZS5sZW5ndGg7XG4gIGNvbnN0IGZpcnN0TGluZUJyZWFrID0gc291cmNlLmluZGV4T2YoXCJcXG5cIiwgc3RhcnQpO1xuICBjb25zdCBzZWNvbmRMaW5lQnJlYWsgPSBzb3VyY2UuaW5kZXhPZihcIlxcblwiLCBmaXJzdExpbmVCcmVhayArIDEpO1xuICBjb25zdCBlbXB0eUxpbmUgPSBzb3VyY2VcbiAgICAuc3Vic3RyaW5nKGZpcnN0TGluZUJyZWFrICsgMSwgc2Vjb25kTGluZUJyZWFrKVxuICAgIC50cmltKCk7XG4gIGNvbnN0IGlzTGFzdE5vZGUgPSAhIXNvdXJjZS5zdWJzdHJpbmcoc3RhcnQpLm1hdGNoKC9eXFxzKiQvKTtcblxuICByZXR1cm4gKFxuICAgIGZpcnN0TGluZUJyZWFrICE9PSAtMSAmJiBzZWNvbmRMaW5lQnJlYWsgIT09IC0xICYmICFlbXB0eUxpbmUgJiYgIWlzTGFzdE5vZGVcbiAgKTtcbn1cblxuZnVuY3Rpb24gZ2V0Rmlyc3RCbG9ja1BhcmVudChub2RlOiBFeGNsdWRlPEdvTm9kZSwgR29Sb290Pik6IHtcbiAgcGFyZW50OiBHb0Jsb2NrIHwgR29Sb290O1xuICBjaGlsZDogdHlwZW9mIG5vZGU7XG59IHtcbiAgbGV0IHByZXZpb3VzID0gbm9kZTtcbiAgbGV0IGN1cnJlbnQgPSBub2RlLnBhcmVudDtcblxuICB3aGlsZSAoIWlzQmxvY2soY3VycmVudCkgJiYgIWlzUm9vdChjdXJyZW50KSkge1xuICAgIHByZXZpb3VzID0gY3VycmVudDtcbiAgICBjdXJyZW50ID0gY3VycmVudC5wYXJlbnQ7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGNoaWxkOiBwcmV2aW91cyxcbiAgICBwYXJlbnQ6IGN1cnJlbnQsXG4gIH07XG59XG5cbmZ1bmN0aW9uIHByaW50UGxhaW5CbG9jayh0ZXh0OiBzdHJpbmcsIGhhcmRsaW5lcyA9IHRydWUpOiBidWlsZGVycy5Eb2Mge1xuICBjb25zdCBpc1RleHRFbXB0eSA9IChpbnB1dDogc3RyaW5nKSA9PiAhIWlucHV0Lm1hdGNoKC9eXFxzKiQvKTtcblxuICBjb25zdCBsaW5lcyA9IHRleHQuc3BsaXQoXCJcXG5cIik7XG5cbiAgY29uc3Qgc2VnbWVudHMgPSBsaW5lcy5maWx0ZXIoXG4gICAgKHZhbHVlLCBpKSA9PiAhKGkgPT0gMCB8fCBpID09IGxpbmVzLmxlbmd0aCAtIDEpIHx8ICFpc1RleHRFbXB0eSh2YWx1ZSlcbiAgKTtcblxuICByZXR1cm4gYnVpbGRlcnMuY29uY2F0KFtcbiAgICAuLi5zZWdtZW50cy5tYXAoKGNvbnRlbnQsIGkpID0+XG4gICAgICBidWlsZGVycy5jb25jYXQoW1xuICAgICAgICBoYXJkbGluZXMgfHwgaSA/IGJ1aWxkZXJzLmhhcmRsaW5lIDogXCJcIixcbiAgICAgICAgYnVpbGRlcnMudHJpbSxcbiAgICAgICAgY29udGVudCxcbiAgICAgIF0pXG4gICAgKSxcbiAgICBoYXJkbGluZXMgPyBidWlsZGVycy5oYXJkbGluZSA6IFwiXCIsXG4gIF0pO1xufVxuIl19